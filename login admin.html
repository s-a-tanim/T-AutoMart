<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T AutoMart - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .logo span {
            color: #fbbf24;
        }

        .firebase-status {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .firebase-connected {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .firebase-disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .login-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }

        .admin-dashboard {
            flex: 1;
            padding: 2rem;
            display: none;
        }

        .tab-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .car-form {
            max-width: 800px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .status-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #16a34a;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .file-upload:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .car-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .car-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .car-list-item:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .car-list-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .car-list-info {
            flex: 1;
        }

        .car-list-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .car-list-details {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            margin-left: 0.5rem;
        }

        .car-list-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit,
        .btn-delete {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        button[type="submit"] {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        button[type="submit"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .logout-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.9);
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            text-align: center;
            color: white;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .car-list-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .car-list-actions {
                align-self: stretch;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="./home/" class="logo">T Auto<span>Mart</span></a>
        <div id="header-actions"></div>
    </header>

    <div id="firebase-status" class="firebase-status firebase-disconnected">
        🔴 Firebase Disconnected
    </div>

    <div class="login-container" id="login-container">
        <div class="login-form">
            <h2>Admin Login</h2>
            <div id="login-alert" class="alert" style="display: none;"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Email</label>
                    <input type="email" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>
    </div>

    <div class="admin-dashboard" id="admin-dashboard">
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="add-car">Add New Car</button>
            <button class="tab-btn" data-tab="manage-cars">Manage Cars</button>
        </div>

        <div id="add-car" class="tab-content active">
            <h2>Add New Vehicle</h2>
            <div id="car-form-alert" class="alert" style="display: none;"></div>
            <form id="car-form" class="car-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="car-make">Maker (Brand name)</label>
                        <select id="car-make" name="make" required>
                            <option value="">Select Make</option>
                            <option value="toyota">Toyota</option>
                            <option value="honda">Honda</option>
                            <option value="mazda">Mazda</option>
                            <option value="nissan">Nissan</option>
                            <option value="suzuki">Suzuki</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="car-model">Enter Model name</label>
                        <input type="text" id="car-model" name="model" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="car-year">Enter Year</label>
                        <select id="car-year" name="year" required>
                            <option value="">Select Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="car-price">Price (৳)</label>
                        <input type="number" id="car-price" name="price" min="0" step="1000" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="car-color">Enter Color</label>
                        <input type="text" id="car-color" name="color" required>
                    </div>
                    <div class="form-group">
                        <label for="car-mileage">Mileage (km)</label>
                        <input type="number" id="car-mileage" name="mileage" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="car-description">Description</label>
                    <textarea id="car-description" name="description" rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label>Car Status</label>
                    <div class="status-toggle">
                        <label for="car-status">Available</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="car-status" name="status" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="status-text" id="status-text">Available</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="car-images">Upload Images</label>
                    <div class="file-upload" id="file-upload">
                        <div class="upload-icon">📁</div>
                        <p>Click to upload images via Cloudinary</p>
                        <p style="font-size: 0.8rem; color: #6bb728; margin-top: 0.5rem;">Upload multiple images at once</p>
                    </div>
                    <div class="image-preview-container" id="image-preview"></div>
                </div>

                <button type="submit">
                    <span id="submit-btn-text">Add Vehicle</span>
                    <span id="submit-btn-loading" class="loading" style="display: none;"></span>
                </button>
            </form>
        </div>

        <div id="manage-cars" class="tab-content">
            <h2>Manage Vehicles</h2>
            <div id="car-list" class="car-list">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">Loading vehicles...</p>
                </div>
            </div>
        </div>

        <button id="logout-btn" class="logout-btn">Logout</button>
    </div>

    <footer>
        <p>&copy; 2025 T AutoMart. All Rights Reserved.</p>
    </footer>

    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <script>
        // ⚠️ REPLACE WITH YOUR FIREBASE CONFIGURATION
          const firebaseConfig = {
    apiKey: "AIzaSyBUQdsGY8uz-U2kjzj7J8bM8a2mz-62IsI",
    authDomain: "t-automart.firebaseapp.com",
    projectId: "t-automart",
    storageBucket: "t-automart.firebasestorage.app",
    messagingSenderId: "991276660416",
    appId: "1:991276660416:web:b4468838b206e23c521f25",
    measurementId: "G-640V7VD1BZ"
  };


        // ⚠️ REPLACE WITH YOUR ADMIN UID (Get this from Firebase Console -> Authentication -> Users)
        const ADMIN_UID = 'DeTy19P3BLaqvOe5KdqW3A0Qsi32';

        // ⚠️ REPLACE WITH YOUR CLOUDINARY CONFIGURATION
        const CLOUDINARY_CONFIG = {
            cloudName: 'det9l6khu',
            uploadPreset: 'u6jy4ryy'
        };

        // Initialize Firebase
        let db, auth, isFirebaseConnected = false;
        let cloudinaryWidget = null;

        // Global variables
        let cars = [];
        let isEditMode = false;
        let editingCarId = null;
        let uploadedImages = []; // Store uploaded image URLs and public_ids

        // DOM references
        const loginContainer = document.getElementById('login-container');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginAlert = document.getElementById('login-alert');
        const carForm = document.getElementById('car-form');
        const carFormAlert = document.getElementById('car-form-alert');
        const logoutBtn = document.getElementById('logout-btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const carList = document.getElementById('car-list');
        const carStatus = document.getElementById('car-status');
        const statusText = document.getElementById('status-text');
        const yearSelect = document.getElementById('car-year');
        const fileUpload = document.getElementById('file-upload');
        const imagePreview = document.getElementById('image-preview');
        const headerActions = document.getElementById('header-actions');
        const submitBtnText = document.getElementById('submit-btn-text');
        const submitBtnLoading = document.getElementById('submit-btn-loading');
        const firebaseStatus = document.getElementById('firebase-status');

        // Update Firebase connection status
        function updateFirebaseStatus(connected) {
            isFirebaseConnected = connected;
            if (connected) {
                firebaseStatus.textContent = '🟢 Firebase Connected';
                firebaseStatus.className = 'firebase-status firebase-connected';
            } else {
                firebaseStatus.textContent = '🔴 Firebase Disconnected';
                firebaseStatus.className = 'firebase-status firebase-disconnected';
            }
        }

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            isFirebaseConnected = true;
            updateFirebaseStatus(true);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            updateFirebaseStatus(false);
        }

        // Initialize Cloudinary Widget
        function initCloudinaryWidget() {
            if (!cloudinaryWidget) {
                cloudinaryWidget = cloudinary.createUploadWidget({
                    cloudName: CLOUDINARY_CONFIG.cloudName,
                    uploadPreset: CLOUDINARY_CONFIG.uploadPreset,
                    sources: ['local', 'url', 'camera'],
                    multiple: true,
                    maxFiles: 10,
                    maxFileSize: 10000000, // 10MB
                    resourceType: 'image',
                    clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    cropping: false,
                    folder: 'car-images',
                    tags: ['car', 'vehicle']
                }, (error, result) => {
                    if (!error && result && result.event === "success") {
                        console.log('Image uploaded successfully:', result.info);
                        addImagePreview(result.info.secure_url, result.info.public_id);
                        showAlert(carFormAlert, 'Image uploaded successfully!', 'success');
                    } else if (error) {
                        console.error('Cloudinary upload error:', error);
                        showAlert(carFormAlert, `Image upload failed: ${error.message}`, 'danger');
                    }
                });
            }
        }


        // Populate year dropdown
        const currentYear = new Date().getFullYear();
        for (let i = currentYear + 1; i >= currentYear - 30; i--) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            yearSelect.appendChild(option);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Cloudinary widget
            initCloudinaryWidget();

            // Firebase Authentication state change listener
            auth.onAuthStateChanged(user => {
                if (user && user.uid === ADMIN_UID) {
                    console.log('Admin logged in:', user.uid);
                    showAdminDashboard();
                    if (isFirebaseConnected) {
                        loadCarsFromFirebase();
                        listenForCarUpdates();
                    } else {
                        showAlert(carFormAlert, 'Firebase not connected. Cannot load vehicle data.', 'danger');
                    }
                } else {
                    console.log('No admin user logged in.');
                    showLoginForm();
                }
            });

            // Event listeners
            carStatus.addEventListener('change', () => {
                statusText.textContent = carStatus.checked ? 'Available' : 'Sold';
            });

            fileUpload.addEventListener('click', () => {
                if (cloudinaryWidget) {
                    cloudinaryWidget.open();
                } else {
                    showAlert(carFormAlert, 'Cloudinary widget not initialized', 'danger');
                }
            });
        });

        // Firebase Functions
        async function loadCarsFromFirebase() {
            if (!isFirebaseConnected) {
                showAlert(carFormAlert, 'Firebase not connected. Cannot load vehicles.', 'danger');
                return;
            }

            try {
                const snapshot = await db.collection('cars').orderBy('createdAt', 'desc').get();
                cars = [];
                snapshot.forEach(doc => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                renderCarList();
            } catch (error) {
                console.error('Error loading cars:', error);
                showAlert(carFormAlert, 'Error loading vehicles from database', 'danger');
            }
        }

        function listenForCarUpdates() {
            if (!isFirebaseConnected || !auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                console.warn('Not authorized or Firebase not connected. Cannot listen for updates.');
                return;
            }

            db.collection('cars').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                cars = [];
                snapshot.forEach(doc => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                renderCarList();
            }, error => {
                console.error('Error listening for updates:', error);
                updateFirebaseStatus(false);
                showAlert(carFormAlert, 'Lost connection to Firebase. Data may not be up-to-date.', 'danger');
            });
        }

        async function addCarToFirebase(carData) {
            if (!isFirebaseConnected) {
                throw new Error('Firebase not connected. Cannot save vehicle.');
            }
            if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                throw new Error('Not authorized to add vehicles.');
            }

            try {
                carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                carData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                carData.addedBy = auth.currentUser.uid;
                await db.collection('cars').add(carData);
            } catch (error) {
                console.error('Error adding car:', error);
                throw new Error('Failed to save vehicle to database: ' + error.message);
            }
        }

        async function updateCarInFirebase(id, carData) {
            if (!isFirebaseConnected) {
                throw new Error('Firebase not connected. Cannot update vehicle.');
            }
            if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                throw new Error('Not authorized to update vehicles.');
            }

            try {
                const updateData = {
                    make: carData.make,
                    model: carData.model,
                    year: carData.year,
                    price: carData.price,
                    color: carData.color,
                    mileage: carData.mileage,
                    description: carData.description,
                    status: carData.status,
                    images: carData.images,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('cars').doc(id).update(updateData);
            } catch (error) {
                console.error('Error updating car:', error);
                throw new Error('Failed to update vehicle in database: ' + error.message);
            }
        }

        async function deleteCarFromFirebase(id) {
            if (!isFirebaseConnected) {
                throw new Error('Firebase not connected. Cannot delete vehicle.');
            }
            if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
                throw new Error('Not authorized to delete vehicles.');
            }

            try {
                const carDoc = await db.collection('cars').doc(id).get();
                if (!carDoc.exists) {
                    throw new Error('Vehicle not found.');
                }
                const carData = carDoc.data();

                // Delete images from Cloudinary
                if (carData.images && carData.images.length > 0) {
                    showAlert(carFormAlert, 'Deleting associated images...', 'warning');
                    // Note: For Cloudinary deletion, you'd need to implement server-side deletion
                    // or use Admin API with your API secret (not recommended for client-side)
                    console.log('Images to delete from Cloudinary:', carData.images);
                }

                await db.collection('cars').doc(id).delete();
                console.log('Car document deleted from Firestore');
                showAlert(carFormAlert, 'Vehicle deleted successfully!', 'success');

                if (isEditMode && editingCarId === id) {
                    resetCarForm();
                }
            } catch (error) {
                console.error('Error deleting car:', error);
                showAlert(carFormAlert, `Error deleting vehicle: ${error.message}`, 'danger');
            }
        }

        // Login - continuing from where the code was cut off
        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!isFirebaseConnected) {
                showAlert(loginAlert, 'Firebase not connected. Cannot authenticate.', 'danger');
                return;
            }

            try {
                showAlert(loginAlert, 'Logging in...', 'warning');
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                if (user.uid !== ADMIN_UID) {
                    await auth.signOut();
                    showAlert(loginAlert, 'Access denied. Admin privileges required.', 'danger');
                    return;
                }

                showAlert(loginAlert, 'Login successful!', 'success');
                setTimeout(() => {
                    showAdminDashboard();
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. ';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage += 'User not found.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many failed attempts. Try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                showAlert(loginAlert, errorMessage, 'danger');
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showAlert(loginAlert, 'Logged out successfully', 'success');
                showLoginForm();
            } catch (error) {
                console.error('Logout error:', error);
                showAlert(carFormAlert, 'Error logging out', 'danger');
            }
        });

        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'manage-cars') {
                loadCarsFromFirebase();
            }
        }

        // Car form submission
        carForm.addEventListener('submit', async e => {
            e.preventDefault();

            if (!isFirebaseConnected) {
                showAlert(carFormAlert, 'Firebase not connected. Cannot save vehicle.', 'danger');
                return;
            }

            const formData = new FormData(carForm);
            const carData = {
                make: formData.get('make'),
                model: formData.get('model'),
                year: parseInt(formData.get('year')),
                price: parseInt(formData.get('price')),
                color: formData.get('color'),
                mileage: parseInt(formData.get('mileage')),
                description: formData.get('description'),
                status: formData.get('status') === 'on' ? 'available' : 'sold',
                images: uploadedImages.map(img => ({
                    url: img.url,
                    publicId: img.publicId
                }))
            };

            // Validation
            if (uploadedImages.length === 0) {
                showAlert(carFormAlert, 'Please upload at least one image', 'warning');
                return;
            }

            try {
                setSubmitButtonLoading(true);

                if (isEditMode) {
                    await updateCarInFirebase(editingCarId, carData);
                    showAlert(carFormAlert, 'Vehicle updated successfully!', 'success');
                } else {
                    await addCarToFirebase(carData);
                    showAlert(carFormAlert, 'Vehicle added successfully!', 'success');
                }

                resetCarForm();
                
                // Auto-switch to manage cars tab
                setTimeout(() => {
                    switchTab('manage-cars');
                }, 1500);

            } catch (error) {
                console.error('Error saving car:', error);
                showAlert(carFormAlert, error.message, 'danger');
            } finally {
                setSubmitButtonLoading(false);
            }
        });

        // Utility Functions
        function showAlert(alertElement, message, type) {
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 3000);
            }
        }

        function showLoginForm() {
            loginContainer.style.display = 'flex';
            adminDashboard.style.display = 'none';
            headerActions.innerHTML = '';
            resetCarForm();
        }

        function showAdminDashboard() {
            loginContainer.style.display = 'none';
            adminDashboard.style.display = 'block';
            headerActions.innerHTML = `<span style="color: white;">Welcome, Admin</span>`;
            clearAlert(loginAlert);
        }

        function clearAlert(alertElement) {
            alertElement.style.display = 'none';
        }

        function setSubmitButtonLoading(loading) {
            const submitBtn = carForm.querySelector('button[type="submit"]');
            if (loading) {
                submitBtn.disabled = true;
                submitBtnText.style.display = 'none';
                submitBtnLoading.style.display = 'inline-block';
            } else {
                submitBtn.disabled = false;
                submitBtnText.style.display = 'inline';
                submitBtnLoading.style.display = 'none';
            }
        }

        function addImagePreview(imageUrl, publicId) {
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-preview';
            
            imageContainer.innerHTML = `
                <img src="${imageUrl}" alt="Car preview">
                <button type="button" class="remove-image" onclick="removeImage('${publicId}')">×</button>
            `;
            
            imagePreview.appendChild(imageContainer);
            uploadedImages.push({ url: imageUrl, publicId: publicId });
        }

        function removeImage(publicId) {
            // Remove from uploaded images array
            uploadedImages = uploadedImages.filter(img => img.publicId !== publicId);
            
            // Remove from DOM
            const imageContainers = imagePreview.querySelectorAll('.image-preview');
            imageContainers.forEach(container => {
                const removeBtn = container.querySelector('.remove-image');
                if (removeBtn && removeBtn.getAttribute('onclick').includes(publicId)) {
                    container.remove();
                }
            });

            showAlert(carFormAlert, 'Image removed', 'success');
        }

        function resetCarForm() {
            carForm.reset();
            imagePreview.innerHTML = '';
            uploadedImages = [];
            isEditMode = false;
            editingCarId = null;
            statusText.textContent = 'Available';
            submitBtnText.textContent = 'Add Vehicle';
            clearAlert(carFormAlert);
            
            // Reset the tab to add-car
            switchTab('add-car');
        }

        function renderCarList() {
            if (cars.length === 0) {
                carList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p>No vehicles found. Add your first vehicle!</p>
                    </div>
                `;
                return;
            }

            carList.innerHTML = cars.map(car => `
                <div class="car-list-item">
                    <img src="${car.images && car.images.length > 0 ? car.images[0].url : 'https://via.placeholder.com/80x60?text=No+Image'}" 
                         alt="${car.make} ${car.model}" class="car-list-image">
                    <div class="car-list-info">
                        <div class="car-list-title">${car.make} ${car.model} (${car.year})</div>
                        <div class="car-list-details">
                            ৳${car.price?.toLocaleString()} • ${car.color} • ${car.mileage?.toLocaleString()}km
                            <span class="status-badge" style="background-color: ${car.status === 'available' ? '#16a34a' : '#dc2626'}">
                                ${car.status === 'available' ? 'Available' : 'Sold'}
                            </span>
                        </div>
                    </div>
                    <div class="car-list-actions">
                        <button class="btn-edit" onclick="editCar('${car.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteCar('${car.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) {
                showAlert(carFormAlert, 'Vehicle not found', 'danger');
                return;
            }

            // Switch to add-car tab
            switchTab('add-car');

            // Fill form with car data
            document.getElementById('car-make').value = car.make;
            document.getElementById('car-model').value = car.model;
            document.getElementById('car-year').value = car.year;
            document.getElementById('car-price').value = car.price;
            document.getElementById('car-color').value = car.color;
            document.getElementById('car-mileage').value = car.mileage;
            document.getElementById('car-description').value = car.description || '';
            
            const statusCheckbox = document.getElementById('car-status');
            statusCheckbox.checked = car.status === 'available';
            statusText.textContent = car.status === 'available' ? 'Available' : 'Sold';

            // Load existing images
            imagePreview.innerHTML = '';
            uploadedImages = [];
            if (car.images && car.images.length > 0) {
                car.images.forEach(image => {
                    addImagePreview(image.url, image.publicId);
                });
            }

            // Set edit mode
            isEditMode = true;
            editingCarId = carId;
            submitBtnText.textContent = 'Update Vehicle';

            showAlert(carFormAlert, 'Editing vehicle. Make changes and click Update Vehicle.', 'warning');
        }

        function deleteCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) {
                showAlert(carFormAlert, 'Vehicle not found', 'danger');
                return;
            }

            const confirmMessage = `Are you sure you want to delete this vehicle?\n\n${car.make} ${car.model} (${car.year})\nPrice: ৳${car.price?.toLocaleString()}`;
            
            if (confirm(confirmMessage)) {
                deleteCarFromFirebase(carId);
            }
        }

        // Global functions for onclick handlers
        window.removeImage = removeImage;
        window.editCar = editCar;
        window.deleteCar = deleteCar;

        // Initialize on page load
        console.log('T AutoMart Admin Dashboard initialized');
        console.log('Firebase Config Status:', isFirebaseConnected ? '✅ Connected' : '❌ Disconnected');
        if (!isFirebaseConnected) {
            console.warn('⚠️ Firebase not properly configured. Please update firebaseConfig with your project details.');
        }
        if (CLOUDINARY_CONFIG.cloudName === 'YOUR_CLOUD_NAME') {
            console.warn('⚠️ Cloudinary not properly configured. Please update CLOUDINARY_CONFIG with your cloud details.');
        }
    </script>
</body>
</html>
